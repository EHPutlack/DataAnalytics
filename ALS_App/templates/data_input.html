<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Input</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .upload-progress-container {
            margin: 20px 0;
            width: 100%;
            border: 1px solid #ddd;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            border: 1px solid #ccc;
        }
        .progress-fill {
            width: 0%;
            height: 100%;
            background-color: #F3A122;
            transition: width 0.3s ease;
        }
        .button {
            padding: 10px 20px;
            background-color: #F3A122;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #F3A122;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-size-warning {
            margin-top: 5px;
            padding: 5px;
            border-radius: 3px;
            background-color: rgba(243, 161, 34, 0.1);
        }
        .upload-progress-container {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background-color: rgba(243, 161, 34, 0.05);
        }
        #uploadStatus {
            color: #F3A122;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <img src="{{ url_for('static', filename='images/Logo.PNG') }}" alt="Logo">
        <h1>Data Input</h1>
    </header>
    <nav>
        <ul>
            <li class="{{ 'active' if request.endpoint == 'index' else '' }}">
                <a href="{{ url_for('index') }}">Home</a>
            </li>
            <li class="{{ 'active' if request.endpoint == 'model_information' else '' }}">
                <a href="{{ url_for('model_information') }}">Model Information</a>
            </li>
            <li class="{{ 'active' if request.endpoint == 'data_input' else '' }}">
                <a href="{{ url_for('data_input') }}">Data Input</a>
            </li>
        </ul>
    </nav>
    <main>
        <section class="data-input-section">
            <h2>Upload Your Data</h2>
            
            <form action="{{ url_for('data_input') }}" method="POST" enctype="multipart/form-data" id="uploadForm">
                <div class="form-group">
                    <label for="file">Choose a file:</label>
                    <input type="file" name="file" id="file" accept=".csv,.xlsx">
                    <div class="file-size-warning" style="display: none; color: #F3A122;">
                        Large file detected. Upload may take a few moments.
                    </div>
                </div>
                <div class="form-group">
                    <label for="model">Select Model:</label>
                    <select name="model" id="model">
                        <option value="">Choose a model</option>
                        <option value="Random Forest">Random Forest</option>
                        <option value="Logistic Regression">Logistic Regression</option>
                        <option value="Support Vector Machine">Support Vector Machine</option>
                        <option value="K-Nearest Neighbors">K-Nearest Neighbors</option>
                        <option value="Decision Tree">Decision Tree</option>
                        <option value="Naive Bayes">Naive Bayes</option>
                        <option value="Gradient Boosting">Gradient Boosting</option>
                        <option value="AdaBoost">AdaBoost</option>
                    </select>
                </div>
                <button type="submit" class="button" id="uploadButton">
                    <span class="button-text">Upload and Process</span>
                    <span class="spinner" style="display: none;"></span>
                </button>
            </form>
            
                <!-- Separate Database Actions -->
                <div class="database-actions" style="margin-top: 20px;">
                    <form action="{{ url_for('clear_database') }}" method="POST" class="clear-database-form">
                        <button type="submit" class="clear-database-btn" onclick="return confirm('Are you sure you want to clear all database tables? This action cannot be undated.');">
                            Clear Database
                        </button>
                    </form>
                    <form action="{{ url_for('restore_backup', table_name='patient_data') }}" method="POST" class="restore-backup-form">
                        <button type="submit" class="restore-backup-btn" onclick="return confirm('Are you sure you want to restore from backup?');">
                            Restore Backup
                        </button>
                    </form>
                </div>
                <!-- Progress Bar Container -->
                <div id="progressContainer" class="upload-progress-container" style="display: none;">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div id="progressText" style="text-align: center;">0%</div>
                    <div id="uploadStatus" style="text-align: center; margin-top: 10px;">Preparing upload...</div>
                    <div class="spinner" style="display: none;"></div>
                </div>
        </section>

            {% if error %}
                <div class="error-message">
                    {{ error }}
                </div>
            {% endif %}

            {% if success_message %}
                <div class="success-section">
                    <h3 class="success-message">{{ success_message }}</h3>

                    {% if stats %}
                        <div class="statistics-container">
                            <h3>Dataset Statistics</h3>

                            <!-- General Statistics -->
                            <p>Total Records: {{ stats['total_records'] }}</p>
                            <div class="stat-section">
                                <h4>Missing Values Summary</h4>
                                <div class="missing-values-grid">
                                    {% for column, count in stats.missing_values.items() %}
                                        <div class="missing-value-item">
                                            <span class="column-name">{{ column }}</span>
                                            <span class="missing-count">{{ count }} ({{ stats.column_statistics[column].missing_percentage }})</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Column Statistics -->
                            <div class="stat-section">
                                <h4>Column Statistics</h4>
                                <div class="column-stats-grid">
                                    {% for column, col_stats in stats.column_statistics.items() %}
                                        <div class="column-stat-card">
                                            <h5>{{ column }}</h5>
                                            <ul class="stat-list">
                                                <li>Mean: {{ col_stats.mean if col_stats.mean is not none else 'N/A' }}</li>
                                                <li>Std Dev: {{ col_stats.std }}</li>
                                                <li>Min: {{ col_stats.min }}</li>
                                                <li>Max: {{ col_stats.max }}</li>
                                                <li>Missing: {{ col_stats.missing_percentage }}</li>
                                            </ul>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    {% if table_name %}
                        <div class="database-info">
                            <h4>Database Information</h4>
                            <p>Data stored in table: {{ table_name }}</p>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </main>

    <footer>
        <p>ALS Detection App - Powered by Flask</p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('file');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadButton = document.getElementById('uploadButton');
        const spinner = document.querySelector('.spinner');
        const sizeWarning = document.querySelector('.file-size-warning');
        // File size check
        fileInput.addEventListener('change', function() {
            if (this.files[0]) {
                const fileSize = this.files[0].size / (1024 * 1024); // Convert to MB
                if (fileSize > 5) { // Show warning for files larger than 5MB
                    sizeWarning.style.display = 'block';
                    sizeWarning.textContent = `Large file detected (${fileSize.toFixed(1)}MB). Upload may take a few moments.`;
                } else {
                    sizeWarning.style.display = 'none';
                }
            }
        });
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!fileInput.files.length) {
                    alert('Please select a file to upload');
                    return;
                }
                const modelSelect = document.getElementById('model');
                if (!modelSelect.value) {
                    alert('Please select a model');
                    return;
                }
                // Show progress elements
                progressContainer.style.display = 'block';
                spinner.style.display = 'inline-block';
                uploadButton.disabled = true;
                uploadStatus.textContent = 'Uploading file...';
                const formData = new FormData(form);
                
                try {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', form.action, true);
                    xhr.upload.onprogress = function(e) {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            progressFill.style.width = percentComplete + '%';
                            progressText.textContent = Math.round(percentComplete) + '%';
                        }
                    };
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            uploadStatus.textContent = 'Processing file...';
                            // Redirect to the response URL or handle the response
                            document.location.href = xhr.responseURL;
                        } else {
                            uploadStatus.textContent = 'Upload failed. Please try again.';
                            uploadButton.disabled = false;
                            spinner.style.display = 'none';
                        }
                    };
                    xhr.onerror = function() {
                        uploadStatus.textContent = 'Upload failed. Please try again.';
                        uploadButton.disabled = false;
                        spinner.style.display = 'none';
                    };
                    xhr.send(formData);
                } catch (error) {
                    console.error('Upload error:', error);
                    uploadStatus.textContent = 'Upload failed. Please try again.';
                    uploadButton.disabled = false;
                    spinner.style.display = 'none';
                }
            });
        }
    });
    </script>
</body>
</html>